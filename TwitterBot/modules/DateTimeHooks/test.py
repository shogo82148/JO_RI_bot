#!/usr/bin/env python
# -*- coding:utf-8 -*-

try:
    import unittest2 as unittest
except (ImportError):
    import unittest

from TwitterBot.TestBot import TestBot
from __init__ import *
import datetime

class TestDateTime(unittest.TestCase):
    kanji_test = (
        (u'一', u'1'),
        (u'二', u'2'),
        (u'三', u'3'),
        (u'四', u'4'),
        (u'五', u'5'),
        (u'六', u'6'),
        (u'七', u'7'),
        (u'八', u'8'),
        (u'九', u'9'),
        (u'〇', u'0'),
        (u'十', u'10'),
        (u'十五', u'15'),
        (u'五十五', u'55'),
        )
    test_set = (
        # 相対時間指定
        (u'1秒', '2000/01/01 00:00:00', '2000/01/01 00:00:01'),
        (u'2.5秒', '2000/01/01 00:00:00', '2000/01/01 00:00:02'), # 秒は少数以下切り捨て
        (u'10秒', '2000/01/01 00:00:00', '2000/01/01 00:00:10'),
        (u'5分', '2000/01/01 00:00:00', '2000/01/01 00:05:00'),
        (u'2.5分', '2000/01/01 00:00:00', '2000/01/01 00:02:30'),
        (u'1時間', '2000/01/01 00:00:00', '2000/01/01 01:00:00'),
        (u'1.5時間', '2000/01/01 00:00:00', '2000/01/01 01:30:00'),
        (u'1日経ったら', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'2日たったら', '2000/01/01 00:00:00', '2000/01/03 00:00:00'),
        (u'1日経過', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'1日後', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'1.5日後', '2000/01/01 00:00:00', '2000/01/02 12:00:00'),
        (u'2週間', '2000/01/01 00:00:00', '2000/01/15 00:00:00'),
        (u'1.5週間', '2000/01/01 00:00:00', '2000/01/11 12:00:00'),
        (u'1ヶ月', '2000/01/01 00:00:00', '2000/02/01 00:00:00'),
        (u'2ヶ月', '2000/01/01 00:00:00', '2000/03/01 00:00:00'),
        (u'1年', '2000/01/01 00:00:00', '2001/01/01 00:00:00'),

        # 相対時間指定マイナス
        (u'1秒前', '2000/01/01 00:00:00', '1999/12/31 23:59:59'),
        (u'2.5秒前', '2000/01/01 00:00:00', '1999/12/31 23:59:58'), # 秒は少数以下切り捨て
        (u'5分前', '2000/01/01 00:00:00', '1999/12/31 23:55:00'),
        (u'2.5分前', '2000/01/01 00:00:00', '1999/12/31 23:57:30'),
        (u'1時間前', '2000/01/01 00:00:00', '1999/12/31 23:00:00'),
        (u'1.5時間前', '2000/01/01 00:00:00', '1999/12/31 22:30:00'),
        (u'1日前', '2000/01/01 00:00:00', '1999/12/31 00:00:00'),
        (u'1.5日前', '2000/01/01 00:00:00', '1999/12/30 12:00:00'),
        (u'2週間前', '2000/01/01 00:00:00', '1999/12/18 00:00:00'),
        (u'1.5週間前', '2000/01/01 00:00:00', '1999/12/21 12:00:00'),
        (u'1ヶ月前', '2000/01/01 00:00:00', '1999/12/01 00:00:00'),
        (u'1年前', '2000/01/01 00:00:00', '1999/01/01 00:00:00'),

        # 一ヶ月の扱い 一ヶ月後の同じ日がない場合は、その月の末日
        (u'1ヶ月', '2000/01/28 00:00:00', '2000/02/28 00:00:00'),
        (u'1ヶ月', '2000/01/29 00:00:00', '2000/02/29 00:00:00'),
        (u'1ヶ月', '2000/01/30 00:00:00', '2000/02/29 00:00:00'),

        # 閏年で無い年のチェック
        (u'1ヶ月', '2001/01/28 00:00:00', '2001/02/28 00:00:00'),
        (u'1ヶ月', '2001/01/29 00:00:00', '2001/02/28 00:00:00'),
        (u'1ヶ月', '2001/01/30 00:00:00', '2001/02/28 00:00:00'),

        # 年指定の閏年チェック
        (u'1年', '2000/02/29 00:00:00', '2001/02/28 00:00:00'),
        (u'4年', '2000/02/29 00:00:00', '2004/02/29 00:00:00'),

        # 相対的な時間指定を表す単語
        (u'明日', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'あす', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'翌日', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'よくじつ', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),
        (u'明日', '2000/01/01 12:00:00', '2000/01/02 00:00:00'),
        (u'明後日', '2000/01/01 00:00:00', '2000/01/03 00:00:00'),
        (u'あさって', '2000/01/01 00:00:00', '2000/01/03 00:00:00'),
        (u'明後日', '2000/01/01 12:00:00', '2000/01/03 00:00:00'),
        (u'明明後日', '2000/01/01 12:00:00', '2000/01/04 00:00:00'),
        (u'明々後日', '2000/01/01 12:00:00', '2000/01/04 00:00:00'),
        (u'しあさって', '2000/01/01 12:00:00', '2000/01/04 00:00:00'),
        (u'昨日', '2000/01/01 00:00:00', '1999/12/31 00:00:00'),
        (u'きのう', '2000/01/01 00:00:00', '1999/12/31 00:00:00'),
        (u'さくじつ', '2000/01/01 00:00:00', '1999/12/31 00:00:00'),
        (u'一昨日', '2000/01/01 00:00:00', '1999/12/30 00:00:00'),
        (u'おととい', '2000/01/01 00:00:00', '1999/12/30 00:00:00'),
        (u'おとつい', '2000/01/01 00:00:00', '1999/12/30 00:00:00'),
        (u'いっさくじつ', '2000/01/01 00:00:00', '1999/12/30 00:00:00'),

        # 直接時間指定
        (u'1時', '2000/01/01 00:00:00', '2000/01/01 01:00:00'),
        (u'9時', '2000/01/01 00:00:00', '2000/01/01 09:00:00'),
        (u'16時', '2000/01/01 00:00:00', '2000/01/01 16:00:00'),
        (u'1時50分', '2000/01/01 00:00:00', '2000/01/01 01:50:00'),
        (u'1:50', '2000/01/01 00:00:00', '2000/01/01 01:50:00'),
        (u'150', '2000/01/01 00:00:00', '2000/01/01 01:50:00'),
        (u'9時55分', '2000/01/01 00:00:00', '2000/01/01 09:55:00'),
        (u'9:55', '2000/01/01 00:00:00', '2000/01/01 09:55:00'),
        (u'955', '2000/01/01 00:00:00', '2000/01/01 09:55:00'),
        (u'16時22分', '2000/01/01 00:00:00', '2000/01/01 16:22:00'),
        (u'16:22', '2000/01/01 00:00:00', '2000/01/01 16:22:00'),
        (u'1622', '2000/01/01 00:00:00', '2000/01/01 16:22:00'),
        (u'1時50分29秒', '2000/01/01 00:00:00', '2000/01/01 01:50:29'),
        (u'1:50:29', '2000/01/01 00:00:00', '2000/01/01 01:50:29'),
        (u'15029', '2000/01/01 00:00:00', '2000/01/01 01:50:29'),
        (u'9時55分8秒', '2000/01/01 00:00:00', '2000/01/01 09:55:08'),
        (u'9:55:08', '2000/01/01 00:00:00', '2000/01/01 09:55:08'),
        (u'95508', '2000/01/01 00:00:00', '2000/01/01 09:55:08'),
        (u'16時22分15秒', '2000/01/01 00:00:00', '2000/01/01 16:22:15'),
        (u'16:22:15', '2000/01/01 00:00:00', '2000/01/01 16:22:15'),
        (u'162215', '2000/01/01 00:00:00', '2000/01/01 16:22:15'),

        # 指定した時間が過ぎている場合(指定した時間ちょうどを含む)
        (u'1時', '2000/01/01 01:00:00', '2000/01/01 13:00:00'), # 12時間表示で指定されたと仮定
        (u'1時', '2000/01/01 13:00:00', '2000/01/02 01:00:00'),
        (u'午前1時', '2000/01/01 01:00:00', '2000/01/02 01:00:00'), # 午前/午後の指定がある場合は翌日
        (u'午後1時', '2000/01/01 13:00:00', '2000/01/02 13:00:00'), # 午前/午後の指定がある場合は翌日
        (u'16時', '2000/01/01 16:00:00', '2000/01/02 16:00:00'), # 午後の時間指定は翌日
        (u'25時', '2000/01/01 16:00:00', '2000/01/02 01:00:00'), # 24より大きな時間はその日のはじめからの経過時間

        # AM/PM指定
        (u'午前1時', '2000/01/01 00:00:00', '2000/01/01 01:00:00'),
        (u'午後1時', '2000/01/01 01:00:00', '2000/01/01 13:00:00'),
        (u'AM1時', '2000/01/01 00:00:00', '2000/01/01 01:00:00'),
        (u'PM1時', '2000/01/01 01:00:00', '2000/01/01 13:00:00'),
        (u'a.m.1時', '2000/01/01 00:00:00', '2000/01/01 01:00:00'),
        (u'p.m.1時', '2000/01/01 01:00:00', '2000/01/01 13:00:00'),

        # 直接日にち指定
        (u'4日', '2000/01/01 00:00:00', '2000/01/04 00:00:00'),
        (u'2月4日', '2000/01/01 00:00:00', '2000/02/04 00:00:00'),
        (u'2/4', '2000/01/01 00:00:00', '2000/02/04 00:00:00'),
        (u'2-4', '2000/01/01 00:00:00', '2000/02/04 00:00:00'),
        (u'2.4', '2000/01/01 00:00:00', '2000/02/04 00:00:00'),

        # 期日を過ぎていた場合の処理
        (u'4日', '2000/01/04 12:00:00', '2000/01/04 00:00:00'), # 当日はいいことにする
        (u'4日', '2000/01/05 00:00:00', '2000/02/04 00:00:00'), # 翌月にする
        (u'2月4日', '2000/02/05 00:00:00', '2001/02/04 00:00:00'), # 来年にする

        # 直接日にち指定 年月日
        (u'2005年2月4日', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),
        (u'2005/2/4', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),
        (u'2005-2-4', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),
        (u'2005.2.4', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),
        (u'平成17年2月4日', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),
        (u'H17年2月4日', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),
        (u'H17/2/4', '2000/01/01 00:00:00', '2005/02/04 00:00:00'),

        # ユーザ名中の数字は無視
        (u'@shogo82148 明日', '2000/01/01 00:00:00', '2000/01/02 00:00:00'),

        # 組み合わせ
        (u'明日の10時', '2000/01/01 00:00:00', '2000/01/02 10:00:00'),
        (u'4日後の10時', '2012/09/10 20:40:00', '2012/09/14 10:00:00'), # Issue #11
        )

    def setUp(self):
        bot = TestBot()
        bot.append_reply_hook(hook)
        self.bot = bot

    def testkanji(self):
        results = []
        expects = []
        for text, expected in self.kanji_test:
            results.append(kanji2digit(text))
            expects.append(expected)
        self.maxDiff = None
        self.assertListEqual(results, expects)

    def testgettime(self):
        format = '%Y/%m/%d %H:%M:%S'
        results = []
        expects = []
        for text, now, expected in self.test_set:
            now = datetime.datetime.strptime(now, format)
            expected = datetime.datetime.strptime(expected, format)
            result = gettime(text, now)
            results.append((text, now, result))
            expects.append((text, now, expected))

        self.maxDiff = None
        self.assertListEqual(results, expects)
